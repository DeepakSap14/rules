/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { isArray, isBlank, isPresent, isStringMap, ListWrapper, MapWrapper } from '@aribaui/core';
import { LocalizedString } from './uimeta';
import { Rule, Selector } from './rule';
import { Meta, OverrideValue } from './meta';
import { ContextFieldPath, Expr, StaticallyResolvableWrapper, StaticDynamicWrapper } from './property-value';
/**
 * @record
 */
export function RuleLoader() { }
function RuleLoader_tsickle_Closure_declarations() {
    /** @type {?} */
    RuleLoader.prototype.loadRules;
}
export class RuleLoaderService {
    constructor() {
    }
    /**
     * @return {?}
     */
    get uiMeta() {
        return this._uiMeta;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set uiMeta(value) {
        this._uiMeta = value;
    }
    /**
     * @param {?} meta
     * @param {?} source
     * @param {?} module
     * @param {?} onRule
     * @return {?}
     */
    loadRules(meta, source, module, onRule) {
        this._uiMeta = /** @type {?} */ (meta);
        source.forEach((val, index) => {
            let /** @type {?} */ rule = this.readRule(val, module);
            if (isPresent(onRule)) {
                onRule(rule);
            }
        });
    }
    /**
     * @param {?} source
     * @param {?} module
     * @return {?}
     */
    loadRulesWithReturn(source, module) {
        let /** @type {?} */ rules = new Array();
        source.forEach((val, index) => {
            let /** @type {?} */ rule = this.readRule(val, module);
            rules.push(rule);
        });
        return rules;
    }
    /**
     * @param {?} jsonRule
     * @param {?} module
     * @return {?}
     */
    readRule(jsonRule, module) {
        let /** @type {?} */ selectors = new Array();
        for (let /** @type {?} */ item of jsonRule._selectors) {
            if (isPresent(item._value) && item._value.constructor === Object && Object.keys(item._value).length === 0) {
                item._value = Meta.NullMarker;
            }
            let /** @type {?} */ selector = new Selector(item._key, item._value, item._isDecl);
            selectors.push(selector);
        }
        let /** @type {?} */ properties = MapWrapper.createFromStringMapWithResolve(jsonRule._properties, (k, v) => {
            if (isStringMap(v) &&
                isPresent(v['t'])) {
                return this.resoveValue(v['t'], v, module);
            }
            else if (isStringMap(v) && !isArray(v)) {
                // we have some
                // other sub level
                // of object
                // literal - lets
                // convert this
                // into Map.
                return MapWrapper.createFromStringMapWithResolve(v, (key, val) => this.resoveValue(val['t'], val, module));
            }
            else if (isArray(v)) {
                // let convert with
                // typings as well
                return ListWrapper.clone(v);
            }
            return v;
        });
        let /** @type {?} */ props = properties.size === 0 ? undefined : properties;
        let /** @type {?} */ rule = new Rule(selectors, props, jsonRule._rank);
        return rule;
    }
    /**
     * @param {?} type
     * @param {?} value
     * @param {?} module
     * @return {?}
     */
    resoveValue(type, value, module) {
        if (isBlank(value)) {
            return null;
        }
        if (type === 'Expr') {
            return new Expr(value['v']);
        }
        else if (type === 'SDW') {
            let /** @type {?} */ expr = new Expr(value['v']);
            return new StaticDynamicWrapper(new StaticallyResolvableWrapper(expr));
        }
        else if (type === 'CFP') {
            return new ContextFieldPath(value['v']);
        }
        else if (type === 'OV') {
            return new OverrideValue(value['v']);
        }
        else if (type === 'i18n' && value['v']['key']) {
            let /** @type {?} */ locKey = value['v']['key'];
            return isPresent(this._uiMeta) ? this._uiMeta.createLocalizedString(locKey, value['v']['defVal'])
                :
                    new LocalizedString(null, module, locKey, value['v']['defVal']);
        }
        return value;
    }
}
RuleLoaderService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
RuleLoaderService.ctorParameters = () => [];
function RuleLoaderService_tsickle_Closure_declarations() {
    /** @type {?} */
    RuleLoaderService.prototype._uiMeta;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVsZS1sb2FkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhcmliYXVpL21ldGF1aS8iLCJzb3VyY2VzIjpbImNvcmUvcnVsZS1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBa0JBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2hHLE9BQU8sRUFBQyxlQUFlLEVBQVMsTUFBTSxVQUFVLENBQUM7QUFDakQsT0FBTyxFQUFDLElBQUksRUFBRSxRQUFRLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFFdEMsT0FBTyxFQUFDLElBQUksRUFBRSxhQUFhLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFDM0MsT0FBTyxFQUNILGdCQUFnQixFQUNoQixJQUFJLEVBQ0osMkJBQTJCLEVBQzNCLG9CQUFvQixFQUN2QixNQUFNLGtCQUFrQixDQUFDOzs7Ozs7Ozs7QUFZMUIsTUFBTTtJQUtGO0tBRUM7Ozs7SUFHRCxJQUFJLE1BQU07UUFFTixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztLQUN2Qjs7Ozs7SUFFRCxJQUFJLE1BQU0sQ0FBQyxLQUFhO1FBRXBCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0tBQ3hCOzs7Ozs7OztJQUVELFNBQVMsQ0FBQyxJQUFVLEVBQUUsTUFBVyxFQUFFLE1BQWMsRUFBRSxNQUE0QjtRQUUzRSxJQUFJLENBQUMsT0FBTyxxQkFBVyxJQUFJLENBQUEsQ0FBQztRQUM1QixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBUSxFQUFFLEtBQVUsRUFBRSxFQUFFO1lBRXBDLHFCQUFJLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN0QyxFQUFF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WUFFL0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUNsRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3pCLENBQUM7b0JBQ0QsSUFBSSxlQUFlLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FFdkU7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDOzs7O1lBbklwQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTcgU0FQIEFyaWJhXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKlxuICpcbiAqL1xuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7aXNBcnJheSwgaXNCbGFuaywgaXNQcmVzZW50LCBpc1N0cmluZ01hcCwgTGlzdFdyYXBwZXIsIE1hcFdyYXBwZXJ9IGZyb20gJ0BhcmliYXVpL2NvcmUnO1xuaW1wb3J0IHtMb2NhbGl6ZWRTdHJpbmcsIFVJTWV0YX0gZnJvbSAnLi91aW1ldGEnO1xuaW1wb3J0IHtSdWxlLCBTZWxlY3Rvcn0gZnJvbSAnLi9ydWxlJztcbmltcG9ydCB7SnNvblJ1bGV9IGZyb20gJy4vanNvbi1ydWxlJztcbmltcG9ydCB7TWV0YSwgT3ZlcnJpZGVWYWx1ZX0gZnJvbSAnLi9tZXRhJztcbmltcG9ydCB7XG4gICAgQ29udGV4dEZpZWxkUGF0aCxcbiAgICBFeHByLFxuICAgIFN0YXRpY2FsbHlSZXNvbHZhYmxlV3JhcHBlcixcbiAgICBTdGF0aWNEeW5hbWljV3JhcHBlclxufSBmcm9tICcuL3Byb3BlcnR5LXZhbHVlJztcblxuXG50eXBlIER5bmFtaWNWYWx1ZVR5cGUgPSAnRXhwcicgfCAnU0RXJyB8ICdDRlAnIHwgJ09WJyB8ICdpMThuJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIFJ1bGVMb2FkZXJcbntcbiAgICBsb2FkUnVsZXMgKG1ldGE6IE1ldGEsIHNvdXJjZTogYW55LCBtb2R1bGU6IHN0cmluZywgb25SdWxlOiAocnVsZTogUnVsZSkgPT4gdm9pZCk6IHZvaWQ7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSdWxlTG9hZGVyU2VydmljZSBpbXBsZW1lbnRzIFJ1bGVMb2FkZXJcbntcblxuICAgIHByaXZhdGUgX3VpTWV0YTogVUlNZXRhO1xuXG4gICAgY29uc3RydWN0b3IoKVxuICAgIHtcbiAgICB9XG5cblxuICAgIGdldCB1aU1ldGEoKTogVUlNZXRhXG4gICAge1xuICAgICAgICByZXR1cm4gdGhpcy5fdWlNZXRhO1xuICAgIH1cblxuICAgIHNldCB1aU1ldGEodmFsdWU6IFVJTWV0YSlcbiAgICB7XG4gICAgICAgIHRoaXMuX3VpTWV0YSA9IHZhbHVlO1xuICAgIH1cblxuICAgIGxvYWRSdWxlcyhtZXRhOiBNZXRhLCBzb3VyY2U6IGFueSwgbW9kdWxlOiBzdHJpbmcsIG9uUnVsZTogKHJ1bGU6IFJ1bGUpID0+IHZvaWQpXG4gICAge1xuICAgICAgICB0aGlzLl91aU1ldGEgPSA8VUlNZXRhPm1ldGE7XG4gICAgICAgIHNvdXJjZS5mb3JFYWNoKCh2YWw6IGFueSwgaW5kZXg6IGFueSkgPT5cbiAgICAgICAge1xuICAgICAgICAgICAgbGV0IHJ1bGUgPSB0aGlzLnJlYWRSdWxlKHZhbCwgbW9kdWxlKTtcbiAgICAgICAgICAgIGlmIChpc1ByZXNlbnQob25SdWxlKSkge1xuICAgICAgICAgICAgICAgIG9uUnVsZShydWxlKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuXG4gICAgfVxuXG4gICAgbG9hZFJ1bGVzV2l0aFJldHVybihzb3VyY2U6IGFueSwgbW9kdWxlOiBzdHJpbmcpOiBBcnJheTxSdWxlPlxuICAgIHtcblxuICAgICAgICBsZXQgcnVsZXM6IEFycmF5PFJ1bGU+ID0gbmV3IEFycmF5PFJ1bGU+KCk7XG4gICAgICAgIHNvdXJjZS5mb3JFYWNoKCh2YWw6IGFueSwgaW5kZXg6IGFueSkgPT5cbiAgICAgICAge1xuICAgICAgICAgICAgbGV0IHJ1bGUgPSB0aGlzLnJlYWRSdWxlKHZhbCwgbW9kdWxlKTtcbiAgICAgICAgICAgIHJ1bGVzLnB1c2gocnVsZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBydWxlcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgcmVhZFJ1bGUoanNvblJ1bGU6IEpzb25SdWxlLCBtb2R1bGU6IHN0cmluZyk6IFJ1bGVcbiAgICB7XG5cbiAgICAgICAgbGV0IHNlbGVjdG9yczogQXJyYXk8U2VsZWN0b3I+ID0gbmV3IEFycmF5PFNlbGVjdG9yPigpO1xuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGpzb25SdWxlLl9zZWxlY3RvcnMpIHtcblxuICAgICAgICAgICAgaWYgKGlzUHJlc2VudChpdGVtLl92YWx1ZSkgJiYgaXRlbS5fdmFsdWUuY29uc3RydWN0b3IgPT09IE9iamVjdCAmJiBPYmplY3Qua2V5cyhcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5fdmFsdWUpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGl0ZW0uX3ZhbHVlID0gTWV0YS5OdWxsTWFya2VyO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgc2VsZWN0b3IgPSBuZXcgU2VsZWN0b3IoaXRlbS5fa2V5LCBpdGVtLl92YWx1ZSwgaXRlbS5faXNEZWNsKTtcbiAgICAgICAgICAgIHNlbGVjdG9ycy5wdXNoKHNlbGVjdG9yKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcHJvcGVydGllcyA9IE1hcFdyYXBwZXIuY3JlYXRlRnJvbVN0cmluZ01hcFdpdGhSZXNvbHZlPGFueT4oanNvblJ1bGUuX3Byb3BlcnRpZXMsXG4gICAgICAgICAgICAoaywgdikgPT5cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmdNYXAodikgJiZcbiAgICAgICAgICAgICAgICAgICAgaXNQcmVzZW50KHZbJ3QnXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzb3ZlVmFsdWUoXG4gICAgICAgICAgICAgICAgICAgICAgICB2Wyd0J10sIHYsXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdHJpbmdNYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICB2KSAmJiAhaXNBcnJheShcbiAgICAgICAgICAgICAgICAgICAgICAgIHYpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgc29tZVxuICAgICAgICAgICAgICAgICAgICAvLyBvdGhlciBzdWIgbGV2ZWxcbiAgICAgICAgICAgICAgICAgICAgLy8gb2Ygb2JqZWN0XG4gICAgICAgICAgICAgICAgICAgIC8vIGxpdGVyYWwgLSBsZXRzXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnZlcnQgdGhpc1xuICAgICAgICAgICAgICAgICAgICAvLyBpbnRvIE1hcC5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hcFdyYXBwZXIuY3JlYXRlRnJvbVN0cmluZ01hcFdpdGhSZXNvbHZlPGFueT4oXG4gICAgICAgICAgICAgICAgICAgICAgICB2LCAoa2V5LCB2YWwpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvdmVWYWx1ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsWyd0J10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlKSk7XG5cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodikpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbGV0IGNvbnZlcnQgd2l0aFxuICAgICAgICAgICAgICAgICAgICAvLyB0eXBpbmdzIGFzIHdlbGxcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIExpc3RXcmFwcGVyLmNsb25lPHN0cmluZz4oXG4gICAgICAgICAgICAgICAgICAgICAgICB2KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgbGV0IHByb3BzID0gcHJvcGVydGllcy5zaXplID09PSAwID8gdW5kZWZpbmVkIDogcHJvcGVydGllcztcbiAgICAgICAgbGV0IHJ1bGU6IFJ1bGUgPSBuZXcgUnVsZShzZWxlY3RvcnMsIHByb3BzLCBqc29uUnVsZS5fcmFuayk7XG5cbiAgICAgICAgcmV0dXJuIHJ1bGU7XG4gICAgfVxuXG5cbiAgICAvLyAnRXhwcicgfCAnU0RXJyB8ICdDRlAnIHwgJ09WJyB8ICdpMThuJztcbiAgICBwcml2YXRlIHJlc292ZVZhbHVlKHR5cGU6IER5bmFtaWNWYWx1ZVR5cGUsIHZhbHVlOiBhbnksIG1vZHVsZTogc3RyaW5nKTogYW55XG4gICAge1xuICAgICAgICBpZiAoaXNCbGFuayh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGUgPT09ICdFeHByJykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBFeHByKHZhbHVlWyd2J10pO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTRFcnKSB7XG4gICAgICAgICAgICBsZXQgZXhwciA9IG5ldyBFeHByKHZhbHVlWyd2J10pO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBTdGF0aWNEeW5hbWljV3JhcHBlcihuZXcgU3RhdGljYWxseVJlc29sdmFibGVXcmFwcGVyKGV4cHIpKTtcblxuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdDRlAnKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbnRleHRGaWVsZFBhdGgodmFsdWVbJ3YnXSk7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnT1YnKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE92ZXJyaWRlVmFsdWUodmFsdWVbJ3YnXSk7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaTE4bicgJiYgdmFsdWVbJ3YnXVsna2V5J10pIHtcbiAgICAgICAgICAgIGxldCBsb2NLZXkgPSB2YWx1ZVsndiddWydrZXknXTtcblxuICAgICAgICAgICAgcmV0dXJuIGlzUHJlc2VudCh0aGlzLl91aU1ldGEpID8gdGhpcy5fdWlNZXRhLmNyZWF0ZUxvY2FsaXplZFN0cmluZyhsb2NLZXksXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlWyd2J11bJ2RlZlZhbCddKVxuICAgICAgICAgICAgICAgIDpcbiAgICAgICAgICAgICAgICBuZXcgTG9jYWxpemVkU3RyaW5nKG51bGwsIG1vZHVsZSwgbG9jS2V5LCB2YWx1ZVsndiddWydkZWZWYWwnXSk7XG5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWU7XG5cbiAgICB9XG59XG4iXX0=